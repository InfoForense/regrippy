
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Writing tests for your plugins &#8212; RegRippy 0.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="RegRip.py standard classes" href="regrip.html" />
    <link rel="prev" title="Creating a plugin" href="createplugin.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="regrip.html" title="RegRip.py standard classes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="createplugin.html" title="Creating a plugin"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">RegRippy 0.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="writing-tests-for-your-plugins">
<h1>Writing tests for your plugins<a class="headerlink" href="#writing-tests-for-your-plugins" title="Permalink to this headline">¶</a></h1>
<p>In order to make sure your plugins don’t break when there is an architectural change in the
core of the program, or to allow you some peace of mind when upgrading them, it is highly
recommended to write tests.</p>
<p>We use the <a class="reference external" href="https://pytest.org">pytest</a> library for all tests. Each plugin should have a corresponding
<cite>test_[plugin].py</cite> in the <cite>tests/</cite> directory.</p>
<p>In order to not have to create your own hives when testing your plugins, we have developed
classes mocking all classes from python-registry. You can build a fake registry tree using these
and pass it to your plugin constructor.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.reg_mock</span> <span class="k">import</span> <span class="n">RegistryMock</span><span class="p">,</span> <span class="n">RegistryKeyMock</span><span class="p">,</span> <span class="n">RegistryValueMock</span><span class="p">,</span> <span class="n">LoggerMock</span>
<span class="kn">from</span> <span class="nn">Registry.Registry</span> <span class="k">import</span> <span class="n">RegSZ</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">regrippy.plugins.rdphint</span> <span class="k">import</span> <span class="n">Plugin</span>  <span class="k">as</span> <span class="n">plugin</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_reg</span><span class="p">():</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">RegistryKeyMock</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s2">&quot;Software</span><span class="se">\\</span><span class="s2">Microsoft</span><span class="se">\\</span><span class="s2">Terminal Server Client</span><span class="se">\\</span><span class="s2">Servers&quot;</span><span class="p">)</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">RegistryMock</span><span class="p">(</span><span class="s2">&quot;NTUSER.DAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ntuser.dat&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">root</span><span class="p">())</span>

    <span class="n">srv1</span> <span class="o">=</span> <span class="n">RegistryKeyMock</span><span class="p">(</span><span class="s2">&quot;server1.com&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">srv2</span> <span class="o">=</span> <span class="n">RegistryKeyMock</span><span class="p">(</span><span class="s2">&quot;server2.com&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="n">key</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">srv1</span><span class="p">)</span>
    <span class="n">key</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">srv2</span><span class="p">)</span>

    <span class="n">srv1username</span> <span class="o">=</span> <span class="n">RegistryValueMock</span><span class="p">(</span><span class="s2">&quot;UsernameHint&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">RegSZ</span><span class="p">)</span>
    <span class="n">srv1</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">srv1username</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reg</span>


<span class="k">def</span> <span class="nf">test_rdphint</span><span class="p">(</span><span class="n">mock_reg</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="n">mock_reg</span><span class="p">,</span> <span class="n">LoggerMock</span><span class="p">(),</span> <span class="s2">&quot;NTUSER.DAT&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;There should only be 2 results&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">key_name</span> <span class="o">==</span> <span class="s2">&quot;server1.com&quot;</span><span class="p">),</span> <span class="s2">&quot;First server should be server1.com&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">custom</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">),</span> <span class="s2">&quot;First server should have user hint&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">key_name</span> <span class="o">==</span> <span class="s2">&quot;server2.com&quot;</span><span class="p">),</span> <span class="s2">&quot;Second server should be server2.com&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">custom</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;Second server should not have username&quot;</span>
</pre></div>
</div>
<dl class="class">
<dt id="reg_mock.RegistryMock">
<em class="property">class </em><code class="sig-prename descclassname">reg_mock.</code><code class="sig-name descname">RegistryMock</code><a class="headerlink" href="#reg_mock.RegistryMock" title="Permalink to this definition">¶</a></dt>
<dd><p>Mocks the <cite>Registry.Registry</cite> class.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hive_name</strong> (<em>str</em>) – the “internal name” of the hive</p></li>
<li><p><strong>hive_type</strong> (<em>str</em>) – the type of the hive. Usually a standard hive name in lowercase</p></li>
<li><p><strong>root</strong> (<a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock"><em>reg_mock.RegistryKeyMock</em></a>) – the root key. Use <a class="reference internal" href="#reg_mock.RegistryKeyMock.root" title="reg_mock.RegistryKeyMock.root"><code class="xref py py-meth docutils literal notranslate"><span class="pre">root()</span></code></a> to get it.</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="reg_mock.RegistryMock.hive_type">
<code class="sig-name descname">hive_type</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryMock.hive_type" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryMock.hive_name">
<code class="sig-name descname">hive_name</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryMock.hive_name" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryMock.root">
<code class="sig-name descname">root</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryMock.root" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the root key</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>this hive’s root key</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p><a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock">reg_mock.RegistryKeyMock</a></p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryMock.open">
<code class="sig-name descname">open</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryMock.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens a child key.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em>) – the path to the child key</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the child key.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock">reg_mock.RegistryKeyMock</a></p>
</dd>
<dt class="field-even">Raises</dt>
<dd class="field-even"><p><strong>RegistryKeyNotFoundException</strong> – if the key doesn’t exist</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryMock.set_ccs">
<code class="sig-name descname">set_ccs</code><span class="sig-paren">(</span><em class="sig-param">number</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryMock.set_ccs" title="Permalink to this definition">¶</a></dt>
<dd><p>Helper function to create the <cite>Select</cite> key which determines which <cite>ControlSet00X</cite> key to open.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>number</strong> (<em>int</em>) – the current ControlSet number</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="reg_mock.RegistryKeyMock">
<em class="property">class </em><code class="sig-prename descclassname">reg_mock.</code><code class="sig-name descname">RegistryKeyMock</code><a class="headerlink" href="#reg_mock.RegistryKeyMock" title="Permalink to this definition">¶</a></dt>
<dd><p>Mocks the <cite>Registry.RegistryKey</cite> class.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – the name of the key</p></li>
<li><p><strong>parent</strong> (<a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock"><em>reg_mock.RegistryKeyMock</em></a>) – the parent key. If <cite>None</cite>, this means this key is the root key.</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="reg_mock.RegistryKeyMock.build">
<em class="property">static </em><code class="sig-name descname">build</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.build" title="Permalink to this definition">¶</a></dt>
<dd><p>Build the set of keys forming the given <cite>path</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em>) – the path to the leaf key</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the leaf key within the there</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock">reg_mock.RegistryKeyMock</a></p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.root">
<code class="sig-name descname">root</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.root" title="Permalink to this definition">¶</a></dt>
<dd><p>Find the top-most key accessible from this key.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>the root key of the hive</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p><a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock">reg_mock.RegistryKeyMock</a></p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.open">
<code class="sig-name descname">open</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens a child key.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em>) – the path to the child key</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the child key.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock">reg_mock.RegistryKeyMock</a></p>
</dd>
<dt class="field-even">Raises</dt>
<dd class="field-even"><p><strong>RegistryKeyNotFoundException</strong> – if the key doesn’t exist</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.add_child">
<code class="sig-name descname">add_child</code><span class="sig-paren">(</span><em class="sig-param">key</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.add_child" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a child key to this key.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>key</strong> (<a class="reference internal" href="#reg_mock.RegistryKeyMock" title="reg_mock.RegistryKeyMock"><em>reg_mock.RegistryKeyMock</em></a>) – The child key to add. Make sure you correctly set its <code class="xref py py-attr docutils literal notranslate"><span class="pre">parent</span></code> attribute.</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.add_value">
<code class="sig-name descname">add_value</code><span class="sig-paren">(</span><em class="sig-param">value</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.add_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a value to this key.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>value</strong> (<a class="reference internal" href="#reg_mock.RegistryValueMock" title="reg_mock.RegistryValueMock"><em>reg_mock.RegistryValueMock</em></a>) – the value to add.</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.path">
<code class="sig-name descname">path</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.path" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.subkeys">
<code class="sig-name descname">subkeys</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.subkeys" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.values">
<code class="sig-name descname">values</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.values" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.name">
<code class="sig-name descname">name</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.name" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryKeyMock.value">
<code class="sig-name descname">value</code><span class="sig-paren">(</span><em class="sig-param">name</em><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryKeyMock.value" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="class">
<dt id="reg_mock.RegistryValueMock">
<em class="property">class </em><code class="sig-prename descclassname">reg_mock.</code><code class="sig-name descname">RegistryValueMock</code><a class="headerlink" href="#reg_mock.RegistryValueMock" title="Permalink to this definition">¶</a></dt>
<dd><p>Mocks the <cite>Registry.RegistryValue</cite> class.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – the value name</p></li>
<li><p><strong>data</strong> (<em>variable</em>) – the data contained in this value</p></li>
<li><p><strong>type</strong> (<em>Registry.</em><em>[</em><em>RegSZ</em><em>, </em><em>RegDWord</em><em>, </em><em>..</em><em>]</em>) – the data type</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="reg_mock.RegistryValueMock.name">
<code class="sig-name descname">name</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryValueMock.name" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryValueMock.value">
<code class="sig-name descname">value</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryValueMock.value" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryValueMock.value_type">
<code class="sig-name descname">value_type</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryValueMock.value_type" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="reg_mock.RegistryValueMock.value_type_str">
<code class="sig-name descname">value_type_str</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#reg_mock.RegistryValueMock.value_type_str" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="createplugin.html"
                        title="previous chapter">Creating a plugin</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="regrip.html"
                        title="next chapter">RegRip.py standard classes</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="regrip.html" title="RegRip.py standard classes"
             >next</a> |</li>
        <li class="right" >
          <a href="createplugin.html" title="Creating a plugin"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">RegRippy 0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Airbus CERT.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>